"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const all_1 = require("novel-downloader/src/all");
const child_process_1 = require("child_process");
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const bluebird_1 = __importDefault(require("bluebird"));
const stream_1 = require("stream");
const file_type_1 = require("file-type");
const const_1 = require("./lib/const");
const app = express_1.default();
console.log(`build cache`);
child_process_1.spawnSync('node', [
    path_1.join(__dirname, `./cli/cache.js`),
]);
app.use('/file/:siteID/:id', (req, res) => {
    return bluebird_1.default
        .resolve()
        .then(async () => {
        console.log(req.baseUrl, req.url, req.params);
        let siteID = req.params.siteID;
        let novel_id = req.params.id;
        if (siteID.toLowerCase() === 'dmzj') {
            siteID = all_1.EnumNovelSiteList.NovelSiteDmzjApi;
        }
        let map_file = const_1.__cacheMapFile;
        let cp = child_process_1.spawnSync('node', [
            path_1.join(__dirname, `./cli/cli.js`),
            '--mod',
            'all',
            '--siteID',
            siteID,
            '--novel_id',
            novel_id,
        ], {
            stdio: 'inherit',
        });
        let map = await fs_extra_1.readJSON(map_file);
        let _data = map[siteID][novel_id];
        if (map[_data.siteID])
            delete map[_data.siteID][_data.novel_id2];
        if (map[_data.IDKEY])
            delete map[_data.IDKEY][_data.novel_id2];
        if (map[_data.siteID])
            delete map[_data.siteID][_data.novel_id];
        if (map[_data.IDKEY])
            delete map[_data.IDKEY][_data.novel_id];
        if (map[siteID])
            delete map[siteID][novel_id];
        await fs_extra_1.writeJSON(map_file, map, { spaces: 2 }).catch(e => {
            console.error(e);
        });
        return _data;
    })
        .then(async (data) => {
        let fileContents = await fs_extra_1.readFile(data.epub);
        let readStream = new stream_1.PassThrough();
        readStream.end(fileContents);
        let { mime, ext } = await file_type_1.fromBuffer(fileContents);
        if (ext === 'epub' && mime === 'application/zip') {
            mime = 'application/epub+zip';
        }
        res.set('Content-disposition', 'attachment; filename=' + data.IDKEY + '_' + path_1.basename(data.epub));
        res.set('Content-Type', mime);
        console.log(`send file to client`);
        readStream.pipe(res);
        if (typeof data.removeCallback === 'function') {
            data.removeCallback();
        }
        else {
            fs_extra_1.remove(data.outputDir);
        }
    })
        .catch(e => {
        let { message } = e;
        if (e.code === 'ENOENT') {
            message = `id 不存在 或 伺服器離線`;
        }
        res.json({
            error: message,
            params: req.params,
        });
        console.error(`catch error`, e);
    });
});
app.use('/*', (req, res) => res.end('Welcome to micro'));
console.log(`server setup ready`);
exports.default = app;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUlBLHNEQUE4QjtBQUM5QixrREFBNkQ7QUFDN0QsaURBQTBDO0FBQzFDLHVDQUErRTtBQUMvRSwrQkFBc0M7QUFDdEMsd0RBQWdDO0FBRWhDLG1DQUFxQztBQUNyQyx5Q0FBdUM7QUFDdkMsdUNBQTZDO0FBRTdDLE1BQU0sR0FBRyxHQUFHLGlCQUFPLEVBQUUsQ0FBQztBQUV0QixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzNCLHlCQUFTLENBQUMsTUFBTSxFQUFFO0lBQ2pCLFdBQUksQ0FBQyxTQUFTLEVBQUUsZ0JBQWdCLENBQUM7Q0FDakMsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUN6QyxPQUFPLGtCQUFRO1NBQ2IsT0FBTyxFQUFFO1NBQ1QsSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBRWhCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU5QyxJQUFJLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUMvQixJQUFJLFFBQVEsR0FBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUU1QixJQUFJLE1BQU0sQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNLEVBQ25DO1lBQ0MsTUFBTSxHQUFHLHVCQUFpQixDQUFDLGdCQUFnQixDQUFBO1NBQzNDO1FBRUQsSUFBSSxRQUFRLEdBQUcsc0JBQWMsQ0FBQztRQUU5QixJQUFJLEVBQUUsR0FBRyx5QkFBUyxDQUFDLE1BQU0sRUFBRTtZQUMxQixXQUFJLENBQUMsU0FBUyxFQUFFLGNBQWMsQ0FBQztZQUMv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QUNDLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQTtTQUMxQjtRQUVELEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDUixLQUFLLEVBQUUsT0FBTztZQUNkLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtTQUNsQixDQUFDLENBQUE7UUFFRixPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUVoQyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFDO0FBRUgsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztBQUV6RCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDbEMsa0JBQWUsR0FBRyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAyMC8xLzI4LlxuICovXG5pbXBvcnQgbWljcm8sIHsgUmVxdWVzdEhhbmRsZXIsIGJ1ZmZlciwgdGV4dCwganNvbiB9IGZyb20gJ21pY3JvJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgRW51bU5vdmVsU2l0ZUxpc3QgfSBmcm9tICdub3ZlbC1kb3dubG9hZGVyL3NyYy9hbGwnO1xuaW1wb3J0IHsgc3Bhd25TeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyByZWFkSlNPTiwgcmVhZEpTT05TeW5jLCByZWFkRmlsZSwgcmVtb3ZlLCB3cml0ZUpTT04gfSBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgeyBqb2luLCBiYXNlbmFtZSB9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgSUNhY2hlTWFwIH0gZnJvbSAnLi9saWIvdHlwZXMnO1xuaW1wb3J0IHsgUGFzc1Rocm91Z2ggfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgZnJvbUJ1ZmZlciB9IGZyb20gJ2ZpbGUtdHlwZSc7XG5pbXBvcnQgeyBfX2NhY2hlTWFwRmlsZSB9IGZyb20gJy4vbGliL2NvbnN0JztcblxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG5jb25zb2xlLmxvZyhgYnVpbGQgY2FjaGVgKTtcbnNwYXduU3luYygnbm9kZScsIFtcblx0am9pbihfX2Rpcm5hbWUsIGAuL2NsaS9jYWNoZS5qc2ApLFxuXSk7XG5cbmFwcC51c2UoJy9maWxlLzpzaXRlSUQvOmlkJywgKHJlcSwgcmVzKSA9PiB7XG5cdHJldHVybiBCbHVlYmlyZFxuXHRcdC5yZXNvbHZlKClcblx0XHQudGhlbihhc3luYyAoKSA9PiB7XG5cblx0XHRcdGNvbnNvbGUubG9nKHJlcS5iYXNlVXJsLCByZXEudXJsLCByZXEucGFyYW1zKTtcblxuXHRcdFx0bGV0IHNpdGVJRCA9IHJlcS5wYXJhbXMuc2l0ZUlEO1xuXHRcdFx0bGV0IG5vdmVsX2lkPSByZXEucGFyYW1zLmlkO1xuXG5cdFx0XHRpZiAoc2l0ZUlELnRvTG93ZXJDYXNlKCkgPT09ICdkbXpqJylcblx0XHRcdHtcblx0XHRcdFx0c2l0ZUlEID0gRW51bU5vdmVsU2l0ZUxpc3QuTm92ZWxTaXRlRG16akFwaVxuXHRcdFx0fVxuXG5cdFx0XHRsZXQgbWFwX2ZpbGUgPSBfX2NhY2hlTWFwRmlsZTtcblxuXHRcdFx0bGV0IGNwID0gc3Bhd25TeW5jKCdub2RlJywgW1xuXHRcdFx0XHRqb2luKF9fZGlybmFtZSwgYC4vY2xpL2NsaS5qc2ApLFxuXHRcdFx0XHQnLS1tb2QnLFxuXHRcdFx0XHQnYWxsJyxcblx0XHRcdFx0Jy0tc2l0ZUlEJyxcblx0XHRcdFx0c2l0ZUlELFxuXHRcdFx0XHQnLS1ub3ZlbF9pZCcsXG5cdFx0XHRcdG5vdmVsX2lkLFxuXHRcdFx0XSwge1xuXHRcdFx0XHRzdGRpbzogJ2luaGVyaXQnLFxuXHRcdFx0fSk7XG5cblx0XHRcdGxldCBtYXAgPSBhd2FpdCByZWFkSlNPTihtYXBfZmlsZSkgYXMgSUNhY2hlTWFwO1xuXG5cdFx0XHRsZXQgX2RhdGEgPSBtYXBbc2l0ZUlEXVtub3ZlbF9pZF07XG5cblx0XHRcdGlmIChtYXBbX2RhdGEuc2l0ZUlEXSkgZGVsZXRlIG1hcFtfZGF0YS5zaXRlSURdW19kYXRhLm5vdmVsX2lkMl07XG5cdFx0XHRpZiAobWFwW19kYXRhLklES0VZXSkgZGVsZXRlIG1hcFtfZGF0YS5JREtFWV1bX2RhdGEubm92ZWxfaWQyXTtcblx0XHRcdGlmIChtYXBbX2RhdGEuc2l0ZUlEXSkgZGVsZXRlIG1hcFtfZGF0YS5zaXRlSURdW19kYXRhLm5vdmVsX2lkXTtcblx0XHRcdGlmIChtYXBbX2RhdGEuSURLRVldKSBkZWxldGUgbWFwW19kYXRhLklES0VZXVtfZGF0YS5ub3ZlbF9pZF07XG5cdFx0XHRpZiAobWFwW3NpdGVJRF0pIGRlbGV0ZSBtYXBbc2l0ZUlEXVtub3ZlbF9pZF07XG5cblx0XHRcdGF3YWl0IHdyaXRlSlNPTihtYXBfZmlsZSwgbWFwLCB7c3BhY2VzOjJ9KS5jYXRjaChlID0+IHtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihlKVxuXHRcdFx0fSk7XG5cblx0XHRcdHJldHVybiBfZGF0YVxuXHRcdH0pXG5cdFx0LnRoZW4oYXN5bmMgKGRhdGEpID0+XG5cdFx0e1xuXG5cdFx0XHRsZXQgZmlsZUNvbnRlbnRzID0gYXdhaXQgcmVhZEZpbGUoZGF0YS5lcHViKTtcblxuXHRcdFx0bGV0IHJlYWRTdHJlYW0gPSBuZXcgUGFzc1Rocm91Z2goKTtcblx0XHRcdHJlYWRTdHJlYW0uZW5kKGZpbGVDb250ZW50cyk7XG5cblx0XHRcdGxldCB7IG1pbWUsIGV4dCB9ID0gYXdhaXQgZnJvbUJ1ZmZlcihmaWxlQ29udGVudHMpO1xuXG5cdFx0XHRpZiAoZXh0ID09PSAnZXB1YicgJiYgbWltZSA9PT0gJ2FwcGxpY2F0aW9uL3ppcCcpXG5cdFx0XHR7XG5cdFx0XHRcdG1pbWUgPSAnYXBwbGljYXRpb24vZXB1Yit6aXAnO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXMuc2V0KCdDb250ZW50LWRpc3Bvc2l0aW9uJywgJ2F0dGFjaG1lbnQ7IGZpbGVuYW1lPScgKyBkYXRhLklES0VZICsgJ18nICsgYmFzZW5hbWUoZGF0YS5lcHViKSk7XG5cdFx0XHRyZXMuc2V0KCdDb250ZW50LVR5cGUnLCBtaW1lKTtcblxuXHRcdFx0Y29uc29sZS5sb2coYHNlbmQgZmlsZSB0byBjbGllbnRgKVxuXHRcdFx0cmVhZFN0cmVhbS5waXBlKHJlcyk7XG5cblx0XHRcdGlmICh0eXBlb2YgZGF0YS5yZW1vdmVDYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJylcblx0XHRcdHtcblx0XHRcdFx0ZGF0YS5yZW1vdmVDYWxsYmFjaygpO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRyZW1vdmUoZGF0YS5vdXRwdXREaXIpXG5cdFx0XHR9XG5cdFx0fSlcblx0XHQuY2F0Y2goZSA9PiB7XG5cblx0XHRcdGxldCB7IG1lc3NhZ2UgfSA9IGU7XG5cdFx0XHRpZiAoZS5jb2RlID09PSAnRU5PRU5UJylcblx0XHRcdHtcblx0XHRcdFx0bWVzc2FnZSA9IGBpZCDkuI3lrZjlnKgg5oiWIOS8uuacjeWZqOmboue3mmBcblx0XHRcdH1cblxuXHRcdFx0cmVzLmpzb24oe1xuXHRcdFx0XHRlcnJvcjogbWVzc2FnZSxcblx0XHRcdFx0cGFyYW1zOiByZXEucGFyYW1zLFxuXHRcdFx0fSlcblxuXHRcdFx0Y29uc29sZS5lcnJvcihgY2F0Y2ggZXJyb3JgLCBlKVxuXG5cdFx0fSlcbn0pO1xuXG5hcHAudXNlKCcvKicsIChyZXEsIHJlcykgPT4gcmVzLmVuZCgnV2VsY29tZSB0byBtaWNybycpKTtcblxuY29uc29sZS5sb2coYHNlcnZlciBzZXR1cCByZWFkeWApO1xuZXhwb3J0IGRlZmF1bHQgYXBwXG4iXX0=