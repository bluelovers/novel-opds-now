"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const path_1 = require("path");
const file_1 = __importDefault(require("./file"));
const __root_1 = __importDefault(require("../lib/__root"));
const serve_favicon_1 = __importDefault(require("serve-favicon"));
require("./init");
const opds_1 = __importDefault(require("./opds"));
const serve_1 = __importDefault(require("gun/lib/serve"));
const app = express_1.default();
app.use(serve_1.default);
app.use(serve_favicon_1.default(path_1.join(__root_1.default, 'static', 'favicon.png')));
app.use('/file', file_1.default());
app.use('/opds', opds_1.default());
app.use('/*', (req, res, next) => {
    console.log(req.baseUrl, req.url, req.params);
    next();
});
app.use('/*', (req, res) => {
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.charset = 'utf-8';
    let html = `<meta charset="utf-8"/><script src="/gun.js"><script src="/gun/lib/webrtc.js"></script><script>var gun = Gun(["https://gunjs.herokuapp.com/gun","http://nmr.io:8765/gun",window.location.origin + '/gun']);</script>`;
    res.end(`${html}Welcome to micro<p>請將 <a href="/opds"><script>document.write(window.location.origin + '/opds')</script></a> 加入閱讀器的訂閱內</p><p><script>document.write('<img src="https://chart.apis.google.com/chart?cht=qr&chs=300x300&chl= ' + window.location.origin + '/opds"/>')</script></p>`);
});
console.debug(`server setup ready`);
exports.default = app;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUlBLHNEQUE4QjtBQUk5QiwrQkFBc0M7QUFNdEMsa0RBQWlDO0FBQ2pDLDJEQUFtQztBQUNuQyxrRUFBb0M7QUFHcEMsa0JBQWdCO0FBQ2hCLGtEQUFpQztBQUNqQywwREFBcUM7QUFHckMsTUFBTSxHQUFHLEdBQUcsaUJBQU8sRUFBRSxDQUFDO0FBRXRCLEdBQUcsQ0FBQyxHQUFHLENBQUMsZUFBUSxDQUFDLENBQUM7QUFFbEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyx1QkFBTyxDQUFDLFdBQUksQ0FBQyxnQkFBTSxFQUFFLFFBQVEsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFeEQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsY0FBVyxFQUFFLENBQUMsQ0FBQztBQUNoQyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxjQUFXLEVBQUUsQ0FBQyxDQUFDO0FBRWhDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtJQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDOUMsSUFBSSxFQUFFLENBQUM7QUFDUixDQUFDLENBQUMsQ0FBQztBQUVILEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBRTFCLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEVBQUMsY0FBYyxFQUFFLDBCQUEwQixFQUFDLENBQUMsQ0FBQztJQUNqRSxHQUFHLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUV0QixJQUFJLElBQUksR0FBRyxzTkFBc04sQ0FBQztJQUVsTyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxpUkFBaVIsQ0FBQyxDQUFBO0FBQ2xTLENBQUMsQ0FBQyxDQUFDO0FBRUgsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ3BDLGtCQUFlLEdBQUcsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMjAvMS8yOC5cbiAqL1xuaW1wb3J0IG1pY3JvLCB7IFJlcXVlc3RIYW5kbGVyLCBidWZmZXIsIHRleHQsIGpzb24gfSBmcm9tICdtaWNybyc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IEVudW1Ob3ZlbFNpdGVMaXN0IH0gZnJvbSAnbm92ZWwtZG93bmxvYWRlci9zcmMvYWxsJztcbmltcG9ydCB7IHNwYXduU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgcmVhZEpTT04sIHJlYWRKU09OU3luYywgcmVhZEZpbGUsIHJlbW92ZSwgd3JpdGVKU09OIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgam9pbiwgYmFzZW5hbWUgfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IEJsdWViaXJkIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IElDYWNoZU1hcCB9IGZyb20gJy4uL2xpYi90eXBlcyc7XG5pbXBvcnQgeyBQYXNzVGhyb3VnaCB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBmcm9tQnVmZmVyIH0gZnJvbSAnZmlsZS10eXBlJztcbmltcG9ydCB7IF9fY2FjaGVNYXBGaWxlIH0gZnJvbSAnLi4vbGliL2NvbnN0JztcbmltcG9ydCBmaWxlSGFuZGxlciBmcm9tICcuL2ZpbGUnO1xuaW1wb3J0IF9fcm9vdCBmcm9tICcuLi9saWIvX19yb290JztcbmltcG9ydCBmYXZpY29uIGZyb20gJ3NlcnZlLWZhdmljb24nO1xuaW1wb3J0IHsgc2V0dXBHdW4gfSBmcm9tICcuL2d1bi9zZXR1cCc7XG5cbmltcG9ydCAnLi9pbml0JztcbmltcG9ydCBvcGRzSGFuZGxlciBmcm9tICcuL29wZHMnO1xuaW1wb3J0IGd1blNlcnZlIGZyb20gJ2d1bi9saWIvc2VydmUnO1xuaW1wb3J0IGd1bkh0dHAgZnJvbSAnZ3VuL2xpYi9odHRwJztcblxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG5hcHAudXNlKGd1blNlcnZlKTtcbi8vYXBwLnVzZSgnL2d1bicsIGd1bkh0dHApO1xuYXBwLnVzZShmYXZpY29uKGpvaW4oX19yb290LCAnc3RhdGljJywgJ2Zhdmljb24ucG5nJykpKTtcblxuYXBwLnVzZSgnL2ZpbGUnLCBmaWxlSGFuZGxlcigpKTtcbmFwcC51c2UoJy9vcGRzJywgb3Bkc0hhbmRsZXIoKSk7XG5cbmFwcC51c2UoJy8qJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG5cdGNvbnNvbGUubG9nKHJlcS5iYXNlVXJsLCByZXEudXJsLCByZXEucGFyYW1zKTtcblx0bmV4dCgpO1xufSk7XG5cbmFwcC51c2UoJy8qJywgKHJlcSwgcmVzKSA9PiB7XG5cblx0cmVzLndyaXRlSGVhZCgyMDAsIHsnQ29udGVudC1UeXBlJzogJ3RleHQvaHRtbDsgY2hhcnNldD11dGYtOCd9KTtcblx0cmVzLmNoYXJzZXQgPSAndXRmLTgnO1xuXG5cdGxldCBodG1sID0gYDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiLz48c2NyaXB0IHNyYz1cIi9ndW4uanNcIj48c2NyaXB0IHNyYz1cIi9ndW4vbGliL3dlYnJ0Yy5qc1wiPjwvc2NyaXB0PjxzY3JpcHQ+dmFyIGd1biA9IEd1bihbXCJodHRwczovL2d1bmpzLmhlcm9rdWFwcC5jb20vZ3VuXCIsXCJodHRwOi8vbm1yLmlvOjg3NjUvZ3VuXCIsd2luZG93LmxvY2F0aW9uLm9yaWdpbiArICcvZ3VuJ10pOzwvc2NyaXB0PmA7XG5cblx0cmVzLmVuZChgJHtodG1sfVdlbGNvbWUgdG8gbWljcm88cD7oq4vlsIcgPGEgaHJlZj1cIi9vcGRzXCI+PHNjcmlwdD5kb2N1bWVudC53cml0ZSh3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgJy9vcGRzJyk8L3NjcmlwdD48L2E+IOWKoOWFpemWseiugOWZqOeahOiogumWseWFpzwvcD48cD48c2NyaXB0PmRvY3VtZW50LndyaXRlKCc8aW1nIHNyYz1cImh0dHBzOi8vY2hhcnQuYXBpcy5nb29nbGUuY29tL2NoYXJ0P2NodD1xciZjaHM9MzAweDMwMCZjaGw9ICcgKyB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgJy9vcGRzXCIvPicpPC9zY3JpcHQ+PC9wPmApXG59KTtcblxuY29uc29sZS5kZWJ1Zyhgc2VydmVyIHNldHVwIHJlYWR5YCk7XG5leHBvcnQgZGVmYXVsdCBhcHBcbiJdfQ==