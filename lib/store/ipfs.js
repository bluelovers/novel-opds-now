"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../util/index");
const index_2 = require("../ipfs/index");
const bluebird_1 = require("bluebird");
const checkData_1 = __importDefault(require("../gun/checkData"));
const fetch_ipfs_1 = __importDefault(require("fetch-ipfs"));
const use_ipfs_1 = __importDefault(require("use-ipfs"));
const logger_1 = __importDefault(require("debug-color2/logger"));
const to_ipfs_url_1 = require("to-ipfs-url");
function getIPFSEpubFile(_siteID, _novelID, options) {
    let { query = {} } = options || {};
    let { siteID, novelID } = index_1.handleArgvList(_siteID, _novelID);
    return index_2.getEpubFileInfo(siteID, novelID)
        .catch(bluebird_1.TimeoutError, e => null)
        .then(async (data) => {
        if (checkData_1.default(data)) {
            let { ipfs } = await use_ipfs_1.default()
                .catch(e => logger_1.default.error(e));
            let buf = await fetch_ipfs_1.default(data.href, ipfs)
                .catch(e => null);
            if (buf && buf.length) {
                data.base64 = buf.toString('base64');
                let { base64, filename, exists, timestamp, href } = data;
                let isGun = false;
                if (query.debug || query.force) {
                }
                else if ((Date.now() - data.timestamp) < 86400 * 1000) {
                    isGun = true;
                }
                return {
                    base64,
                    filename,
                    exists,
                    timestamp,
                    isGun,
                    href,
                };
            }
        }
        return null;
    })
        .catch(e => null);
}
exports.getIPFSEpubFile = getIPFSEpubFile;
async function putIPFSEpubFile(_siteID, _novelID, gunData, options) {
    ({ siteID: _siteID, novelID: _novelID } = index_1.handleArgvList(_siteID, _novelID));
    let siteID = _siteID[0];
    let novelID = _novelID[0];
    let { base64, ...data } = gunData;
    let content = Buffer.from(base64, 'base64');
    let { ipfs } = await use_ipfs_1.default()
        .catch(e => logger_1.default.error(e));
    if (!ipfs) {
        return null;
    }
    if (!data.href) {
        let cid;
        logger_1.default.dir(data);
        logger_1.default.debug(`add to IPFS`);
        for await (const result of ipfs.add({
            path: data.filename,
            content,
        }, {
            pin: false,
        })) {
            logger_1.default.debug(result);
            logger_1.default.debug(cid = result.cid.toString());
        }
        data.href = to_ipfs_url_1.toLink(cid, data.filename);
    }
    logger_1.default.success(data.href);
    delete data.base64;
    await index_2.putEpubFileInfo(siteID, novelID, data)
        .tap(async (v) => logger_1.default.debug(await v.json()))
        .tapCatch(v => logger_1.default.error(v));
}
exports.putIPFSEpubFile = putIPFSEpubFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXBmcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImlwZnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx5Q0FBK0M7QUFDL0MseUNBQWlFO0FBQ2pFLHVDQUF3QztBQUN4QyxpRUFBNEM7QUFDNUMsNERBQW1DO0FBQ25DLHdEQUErQjtBQUUvQixpRUFBMEM7QUFDMUMsNkNBQXFDO0FBRXJDLFNBQWdCLGVBQWUsQ0FBQyxPQUEwQixFQUFFLFFBQTJCLEVBQUUsT0FLeEY7SUFFQSxJQUFJLEVBQUUsS0FBSyxHQUFHLEVBQUUsRUFBRSxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFbkMsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxzQkFBYyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUU1RCxPQUFPLHVCQUFlLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQztTQUNyQyxLQUFLLENBQUMsdUJBQVksRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQztTQUM5QixJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1FBRXBCLElBQUksbUJBQVksQ0FBQyxJQUFJLENBQUMsRUFDdEI7WUFDQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxrQkFBTyxFQUFFO2lCQUM1QixLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxnQkFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQVMsQ0FBQyxDQUNyQztZQUVELElBQUksR0FBRyxHQUFHLE1BQU0sb0JBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztpQkFDeEMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQ2pCO1lBRUQsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFDckI7Z0JBQ0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEs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LENBQUMsQ0FBQyxFQUFFLENBQUMsZ0JBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUNsQyxDQUFDO0FBMURELDBDQTBEQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhhbmRsZUFyZ3ZMaXN0IH0gZnJvbSAnLi4vdXRpbC9pbmRleCc7XG5pbXBvcnQgeyBnZXRFcHViRmlsZUluZm8sIHB1dEVwdWJGaWxlSW5mbyB9IGZyb20gJy4uL2lwZnMvaW5kZXgnO1xuaW1wb3J0IHsgVGltZW91dEVycm9yIH0gZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGNoZWNrR3VuRGF0YSBmcm9tICcuLi9ndW4vY2hlY2tEYXRhJztcbmltcG9ydCBmZXRjaElQRlMgZnJvbSAnZmV0Y2gtaXBmcyc7XG5pbXBvcnQgdXNlSVBGUyBmcm9tICd1c2UtaXBmcyc7XG5pbXBvcnQgeyBJR3VuRXB1YkRhdGEsIElHdW5FcHViTm9kZSB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCBjb25zb2xlIGZyb20gJ2RlYnVnLWNvbG9yMi9sb2dnZXInO1xuaW1wb3J0IHsgdG9MaW5rIH0gZnJvbSAndG8taXBmcy11cmwnO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0SVBGU0VwdWJGaWxlKF9zaXRlSUQ6IHN0cmluZyB8IHN0cmluZ1tdLCBfbm92ZWxJRDogc3RyaW5nIHwgc3RyaW5nW10sIG9wdGlvbnM6IHtcblx0cXVlcnk6IHtcblx0XHRkZWJ1Zz86IGJvb2xlYW4sXG5cdFx0Zm9yY2U/OiBib29sZWFuLFxuXHR9LFxufSlcbntcblx0bGV0IHsgcXVlcnkgPSB7fSB9ID0gb3B0aW9ucyB8fCB7fTtcblxuXHRsZXQgeyBzaXRlSUQsIG5vdmVsSUQgfSA9IGhhbmRsZUFyZ3ZMaXN0KF9zaXRlSUQsIF9ub3ZlbElEKTtcblxuXHRyZXR1cm4gZ2V0RXB1YkZpbGVJbmZvKHNpdGVJRCwgbm92ZWxJRClcblx0XHQuY2F0Y2goVGltZW91dEVycm9yLCBlID0+IG51bGwpXG5cdFx0LnRoZW4oYXN5bmMgKGRhdGEpID0+XG5cdFx0e1xuXHRcdFx0aWYgKGNoZWNrR3VuRGF0YShkYXRhKSlcblx0XHRcdHtcblx0XHRcdFx0bGV0IHsgaXBmcyB9ID0gYXdhaXQgdXNlSVBGUygpXG5cdFx0XHRcdFx0LmNhdGNoKGUgPT4gY29uc29sZS5lcnJvcihlKSBhcyBudWxsKVxuXHRcdFx0XHQ7XG5cblx0XHRcdFx0bGV0IGJ1ZiA9IGF3YWl0IGZldGNoSVBGUyhkYXRhLmhyZWYsIGlwZnMpXG5cdFx0XHRcdFx0LmNhdGNoKGUgPT4gbnVsbClcblx0XHRcdFx0O1xuXG5cdFx0XHRcdGlmIChidWYgJiYgYnVmLmxlbmd0aClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGRhdGEuYmFzZTY0ID0gYnVmLnRvU3RyaW5nKCdiYXNlNjQnKTtcblxuXHRcdFx0XHRcdGxldCB7IGJhc2U2NCwgZmlsZW5hbWUsIGV4aXN0cywgdGltZXN0YW1wLCBocmVmIH0gPSBkYXRhO1xuXG5cdFx0XHRcdFx0bGV0IGlzR3VuID0gZmFsc2U7XG5cblx0XHRcdFx0XHRpZiAocXVlcnkuZGVidWcgfHwgcXVlcnkuZm9yY2UpXG5cdFx0XHRcdFx0e1xuXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2UgaWYgKChEYXRlLm5vdygpIC0gZGF0YS50aW1lc3RhbXApIDwgODY0MDAgKiAxMDAwKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGlzR3VuID0gdHJ1ZTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdFx0YmFzZTY0LFxuXHRcdFx0XHRcdFx0ZmlsZW5hbWUsXG5cdFx0XHRcdFx0XHRleGlzdHMsXG5cdFx0XHRcdFx0XHR0aW1lc3RhbXAsXG5cdFx0XHRcdFx0XHRpc0d1bixcblx0XHRcdFx0XHRcdGhyZWYsXG5cdFx0XHRcdFx0fSBhcyBJR3VuRXB1YkRhdGFcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gbnVsbFxuXHRcdH0pXG5cdFx0LmNhdGNoKGUgPT4gbnVsbClcblx0XHQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwdXRJUEZTRXB1YkZpbGUoX3NpdGVJRDogc3RyaW5nIHwgc3RyaW5nW10sXG5cdF9ub3ZlbElEOiBzdHJpbmcgfCBzdHJpbmdbXSxcblx0Z3VuRGF0YTogSUd1bkVwdWJOb2RlLFxuXHRvcHRpb25zPzoge1xuXHRcdHF1ZXJ5Pzoge1xuXHRcdFx0ZGVidWc/OiBib29sZWFuLFxuXHRcdFx0Zm9yY2U/OiBib29sZWFuLFxuXHRcdH0sXG5cdH0sXG4pXG57XG5cdCh7IHNpdGVJRDogX3NpdGVJRCwgbm92ZWxJRDogX25vdmVsSUQgfSA9IGhhbmRsZUFyZ3ZMaXN0KF9zaXRlSUQsIF9ub3ZlbElEKSk7XG5cblx0bGV0IHNpdGVJRCA9IF9zaXRlSURbMF07XG5cdGxldCBub3ZlbElEID0gX25vdmVsSURbMF07XG5cblx0bGV0IHsgYmFzZTY0LCAuLi5kYXRhIH0gPSBndW5EYXRhO1xuXG5cdGxldCBjb250ZW50ID0gQnVmZmVyLmZyb20oYmFzZTY0LCAnYmFzZTY0Jyk7XG5cblx0bGV0IHsgaXBmcyB9ID0gYXdhaXQgdXNlSVBGUygpXG5cdFx0LmNhdGNoKGUgPT4gY29uc29sZS5lcnJvcihlKSBhcyBudWxsKVxuXHQ7XG5cblx0aWYgKCFpcGZzKVxuXHR7XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRpZiAoIWRhdGEuaHJlZilcblx0e1xuXHRcdGxldCBjaWQ6IHN0cmluZztcblxuXHRcdGNvbnNvbGUuZGlyKGRhdGEpO1xuXG5cdFx0Y29uc29sZS5kZWJ1ZyhgYWRkIHRvIElQRlNgKTtcblxuXHRcdGZvciBhd2FpdCAoY29uc3QgcmVzdWx0IG9mIGlwZnMuYWRkKHtcblx0XHRcdHBhdGg6IGRhdGEuZmlsZW5hbWUsXG5cdFx0XHRjb250ZW50LFxuXHRcdH0sIHtcblx0XHRcdHBpbjogZmFsc2UsXG5cdFx0fSkpXG5cdFx0e1xuXHRcdFx0Y29uc29sZS5kZWJ1ZyhyZXN1bHQpO1xuXHRcdFx0Y29uc29sZS5kZWJ1ZyhjaWQgPSByZXN1bHQuY2lkLnRvU3RyaW5nKCkpXG5cdFx0fVxuXG5cdFx0ZGF0YS5ocmVmID0gdG9MaW5rKGNpZCwgZGF0YS5maWxlbmFtZSk7XG5cdH1cblxuXHRjb25zb2xlLnN1Y2Nlc3MoZGF0YS5ocmVmKTtcblx0Ly8gQHRzLWlnbm9yZVxuXHRkZWxldGUgZGF0YS5iYXNlNjQ7XG5cblx0YXdhaXQgcHV0RXB1YkZpbGVJbmZvKHNpdGVJRCwgbm92ZWxJRCwgZGF0YSBhcyBhbnkpXG5cdFx0LnRhcChhc3luYyAodikgPT4gY29uc29sZS5kZWJ1Zyhhd2FpdCB2Lmpzb24oKSkpXG5cdFx0LnRhcENhdGNoKHYgPT4gY29uc29sZS5lcnJvcih2KSlcbn1cbiJdfQ==