#!/usr/bin/env node
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const yargs_1 = __importDefault(require("yargs"));
const download_1 = require("../../lib/download");
const threads_1 = __importDefault(require("../lib/threads"));
const novel_epub_1 = __importDefault(require("novel-epub"));
const fs_extra_1 = require("fs-extra");
const bluebird_1 = __importDefault(require("bluebird"));
const const_1 = require("../../lib/const");
let argv = yargs_1.default
    .option('siteID', {
    string: true,
    demandOption: true,
})
    .option('novel_id', {
    string: true,
    demandOption: true,
})
    .option('outputDir', {
    string: true,
})
    .argv;
bluebird_1.default
    .resolve(download_1.downloadNovel2({
    novel_id: argv.novel_id,
    siteID: argv.siteID,
    outputRoot: argv.outputDir,
    useCached: true,
}))
    .then(async ({ options, download, }) => {
    let { cwd, novel_id, IDKEY, outputDir, novel, ...arr } = await download()
        .tapCatch(e => {
        console.error(`下載來源時發生錯誤`, e);
    });
    console.log(`來源下載完成，開始處理排版`, outputDir);
    await threads_1.default(argv.novel_id, IDKEY, outputDir)
        .tapCatch(e => {
        console.error(`處理排版時發生錯誤`, e);
    });
    console.log(`排版完成，開始打包 epub`);
    let epub = await novel_epub_1.default({
        inputPath: cwd,
        outputPath: cwd,
        padEndDate: false,
        filename: novel_id,
        noLog: true,
        downloadRemoteFile: true,
    })
        .tapCatch(e => {
        console.error(`打包 epub 時發生錯誤`, e);
    });
    let map_file = const_1.__cacheMapFile;
    let map = await fs_extra_1.readJSON(map_file)
        .catch(e => ({}));
    map[argv.siteID] = map[argv.siteID] || {};
    map[IDKEY] = map[IDKEY] || {};
    let _data = {
        ...arr,
        cwd,
        IDKEY,
        novel_id,
        outputDir,
        epub: epub.file,
        status: 2,
        timestamp: Date.now(),
    };
    map[argv.siteID][novel_id] = map[argv.siteID][argv.novel_id] = map[IDKEY][novel_id] = map[IDKEY][argv.novel_id] = _data;
    await fs_extra_1.outputJSON(map_file, map, {
        spaces: 2,
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLGtEQUEwQjtBQUMxQixpREFBMkQ7QUFDM0QsNkRBQXlDO0FBQ3pDLDREQUFtQztBQUNuQyx1Q0FBZ0Q7QUFFaEQsd0RBQWdDO0FBRWhDLDJDQUFpRDtBQUVqRCxJQUFJLElBQUksR0FBRyxlQUFLO0tBQ2QsTUFBTSxDQUFDLFFBQVEsRUFBRTtJQUNqQixNQUFNLEVBQUUsSUFBSTtJQUNaLFlBQVksRUFBRSxJQUFJO0NBQ2xCLENBQUM7S0FDRCxNQUFNLENBQUMsVUFBVSxFQUFFO0lBQ25CLE1BQU0sRUFBRSxJQUFJO0lBQ1osWUFBWSxFQUFFLElBQUk7Q0FDbEIsQ0FBQztLQUNELE1BQU0sQ0FBQyxXQUFXLEVBQUU7SUFDcEIsTUFBTSxFQUFFLElBQUk7Q0FDWixDQUFDO0tBQ0QsSUFBSSxDQUNMO0FBRUQsa0JBQVE7S0FDTixPQUFPLENBQUMseUJBQWMsQ0FBQztJQUN2QixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7SUFDdkIsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO0lBQ25CLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUztJQUMxQixTQUFTLEVBQUUsSUFBSTtDQUNmLENBQUMsQ0FBQztLQUNGLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFDWixPQUFPLEVBQ1AsUUFBUSxHQUNSLEVBQUUsRUFBRTtJQUVKLElBQUksRUFDSCxHQUFHLEVBQ0gsUUFBUSxFQUNSLEtBQUssRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLEdBQUcsR0FBRyxFQUNOLEdBQUcsTUFBTSxRQUFRLEVBQUU7U0FDbEIsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDOUIsQ0FBQyxDQUFDLENBQ0Y7SUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUV4QyxNQUFNLGlCQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDO1NBQ2hELFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQzlCLENBQUMsQ0FBQyxDQUNGO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBRTlCLElBQUksSUFBSSxHQUFHLE1BQU0sb0JBQVMsQ0FBQztRQUMxQixTQUFTLEVBQUUsR0FBRztRQUNkLFVBQVUsRUFBRSxHQUFHO1FBQ2YsVUFBVSxFQUFFLEtBQUs7UUFDakIsUUFBUSxFQUFFLFFBQVE7UUFDbEIsS0FBSyxFQUFFLElBQUk7UUFDWCxrQkFBa0IsRUFBRSxJQUFJO0tBQ3hCLENBQUM7U0FDQSxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUNsQyxDQUFDLENBQUMsQ0FDRjtJQUlELElBQUksUUFBUSxHQUFHLHNCQUFjLENBQUM7SUFFOUIsSUFBSSxHQUFHLEdBQWMsTUFBTSxtQkFBUSxDQUFDLFFBQVEsQ0FBQztTQUMzQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQ2pCO0lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMxQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUU5QixJQUFJLEtBQUssR0FBaUI7UUFDekIsR0FBRyxHQUFHO1FBQ04sR0FBRztRQUNILEtBQUs7UUFDTCxRQUFRO1FBQ1IsU0FBUztRQUNULElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtRQUNmLE1BQU0sR0FBNEI7UUFDbEMsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7S0FDckIsQ0FBQztJQUVGLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBRXhILE1BQU0scUJBQVUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO1FBQy9CLE1BQU0sRUFBRSxDQUFDO0tBQ1QsQ0FBQyxDQUFBO0FBRUgsQ0FBQyxDQUFDLENBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG5cbmltcG9ydCB5YXJncyBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBkb3dubG9hZE5vdmVsMiwgaXM1MDQgfSBmcm9tICcuLi8uLi9saWIvZG93bmxvYWQnO1xuaW1wb3J0IGhhbmRsZUFzeW5jIGZyb20gJy4uL2xpYi90aHJlYWRzJztcbmltcG9ydCBub3ZlbEVwdWIgZnJvbSAnbm92ZWwtZXB1Yic7XG5pbXBvcnQgeyBvdXRwdXRKU09OLCByZWFkSlNPTiB9IGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCBCbHVlYmlyZCBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBJQ2FjaGVNYXBSb3csIElDYWNoZU1hcCwgRW51bUNhY2hlTWFwUm93U3RhdHVzIH0gZnJvbSAnLi4vLi4vbGliL3R5cGVzJztcbmltcG9ydCB7IF9fY2FjaGVNYXBGaWxlIH0gZnJvbSAnLi4vLi4vbGliL2NvbnN0JztcblxubGV0IGFyZ3YgPSB5YXJnc1xuXHQub3B0aW9uKCdzaXRlSUQnLCB7XG5cdFx0c3RyaW5nOiB0cnVlLFxuXHRcdGRlbWFuZE9wdGlvbjogdHJ1ZSxcblx0fSlcblx0Lm9wdGlvbignbm92ZWxfaWQnLCB7XG5cdFx0c3RyaW5nOiB0cnVlLFxuXHRcdGRlbWFuZE9wdGlvbjogdHJ1ZSxcblx0fSlcblx0Lm9wdGlvbignb3V0cHV0RGlyJywge1xuXHRcdHN0cmluZzogdHJ1ZSxcblx0fSlcblx0LmFyZ3ZcbjtcblxuQmx1ZWJpcmRcblx0LnJlc29sdmUoZG93bmxvYWROb3ZlbDIoe1xuXHRcdG5vdmVsX2lkOiBhcmd2Lm5vdmVsX2lkLFxuXHRcdHNpdGVJRDogYXJndi5zaXRlSUQsXG5cdFx0b3V0cHV0Um9vdDogYXJndi5vdXRwdXREaXIsXG5cdFx0dXNlQ2FjaGVkOiB0cnVlLFxuXHR9KSlcblx0LnRoZW4oYXN5bmMgKHtcblx0XHRvcHRpb25zLFxuXHRcdGRvd25sb2FkLFxuXHR9KSA9PlxuXHR7XG5cdFx0bGV0IHtcblx0XHRcdGN3ZCxcblx0XHRcdG5vdmVsX2lkLFxuXHRcdFx0SURLRVksXG5cdFx0XHRvdXRwdXREaXIsXG5cdFx0XHRub3ZlbCxcblx0XHRcdC4uLmFyclxuXHRcdH0gPSBhd2FpdCBkb3dubG9hZCgpXG5cdFx0XHQudGFwQ2F0Y2goZSA9PiB7XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoYOS4i+i8ieS+hua6kOaZgueZvOeUn+mMr+iqpGAsIGUpXG5cdFx0XHR9KVxuXHRcdDtcblxuXHRcdGNvbnNvbGUubG9nKGDkvobmupDkuIvovInlrozmiJDvvIzplovlp4vomZXnkIbmjpLniYhgLCBvdXRwdXREaXIpO1xuXG5cdFx0YXdhaXQgaGFuZGxlQXN5bmMoYXJndi5ub3ZlbF9pZCwgSURLRVksIG91dHB1dERpcilcblx0XHRcdC50YXBDYXRjaChlID0+IHtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihg6JmV55CG5o6S54mI5pmC55m855Sf6Yyv6KqkYCwgZSlcblx0XHRcdH0pXG5cdFx0O1xuXG5cdFx0Y29uc29sZS5sb2coYOaOkueJiOWujOaIkO+8jOmWi+Wni+aJk+WMhSBlcHViYCk7XG5cblx0XHRsZXQgZXB1YiA9IGF3YWl0IG5vdmVsRXB1Yih7XG5cdFx0XHRpbnB1dFBhdGg6IGN3ZCxcblx0XHRcdG91dHB1dFBhdGg6IGN3ZCxcblx0XHRcdHBhZEVuZERhdGU6IGZhbHNlLFxuXHRcdFx0ZmlsZW5hbWU6IG5vdmVsX2lkLFxuXHRcdFx0bm9Mb2c6IHRydWUsXG5cdFx0XHRkb3dubG9hZFJlbW90ZUZpbGU6IHRydWUsXG5cdFx0fSlcblx0XHRcdC50YXBDYXRjaChlID0+IHtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihg5omT5YyFIGVwdWIg5pmC55m855Sf6Yyv6KqkYCwgZSlcblx0XHRcdH0pXG5cdFx0O1xuXG5cdFx0Ly9jb25zb2xlLmRpcihlcHViLmZpbGUpO1xuXG5cdFx0bGV0IG1hcF9maWxlID0gX19jYWNoZU1hcEZpbGU7XG5cblx0XHRsZXQgbWFwOiBJQ2FjaGVNYXAgPSBhd2FpdCByZWFkSlNPTihtYXBfZmlsZSlcblx0XHRcdC5jYXRjaChlID0+ICh7fSkpXG5cdFx0O1xuXG5cdFx0bWFwW2FyZ3Yuc2l0ZUlEXSA9IG1hcFthcmd2LnNpdGVJRF0gfHwge307XG5cdFx0bWFwW0lES0VZXSA9IG1hcFtJREtFWV0gfHwge307XG5cblx0XHRsZXQgX2RhdGE6IElDYWNoZU1hcFJvdyA9IHtcblx0XHRcdC4uLmFycixcblx0XHRcdGN3ZCxcblx0XHRcdElES0VZLFxuXHRcdFx0bm92ZWxfaWQsXG5cdFx0XHRvdXRwdXREaXIsXG5cdFx0XHRlcHViOiBlcHViLmZpbGUsXG5cdFx0XHRzdGF0dXM6IEVudW1DYWNoZU1hcFJvd1N0YXR1cy5ET05FLFxuXHRcdFx0dGltZXN0YW1wOiBEYXRlLm5vdygpLFxuXHRcdH07XG5cblx0XHRtYXBbYXJndi5zaXRlSURdW25vdmVsX2lkXSA9IG1hcFthcmd2LnNpdGVJRF1bYXJndi5ub3ZlbF9pZF0gPSBtYXBbSURLRVldW25vdmVsX2lkXSA9IG1hcFtJREtFWV1bYXJndi5ub3ZlbF9pZF0gPSBfZGF0YTtcblxuXHRcdGF3YWl0IG91dHB1dEpTT04obWFwX2ZpbGUsIG1hcCwge1xuXHRcdFx0c3BhY2VzOiAyLFxuXHRcdH0pXG5cblx0fSlcbjtcbiJdfQ==